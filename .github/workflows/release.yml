name: Release Windows Direct
on:
  push:
    tags:
      - "v*"

jobs:
  release:
    permissions:
      contents: write
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # ESCRITURA DIRECTA (SIN DECODIFICAR)
      - name: Write Key File Directly
        run: |
          $KeyFile = "$PWD\tauri.key"
          $SecretContent = "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}"

          # Escribir contenido exacto sin procesar
          [System.IO.File]::WriteAllText($KeyFile, $SecretContent, [System.Text.Encoding]::ASCII)

          Write-Host "✅ Clave escrita DIRECTAMENTE (Raw) en: $KeyFile"
          # Solo mostrar los primeros caracteres seguros
          if ($SecretContent.Length -gt 10) {
             Write-Host "DEBUG START: $($SecretContent.Substring(0, 10))..."
          }

      # COMPILAR
      - name: Build Tauri App
        run: npm run tauri build

      # FIRMAR Y GENERAR JSON
      - name: Sign and Generate latest.json
        run: |
          $MsiFile = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi" | Select-Object -First 1
          if (-not $MsiFile) { throw "No se encontró el MSI" }

          $Env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD = "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}"

          # Ejecutar firma
          $SignOutput = npm run tauri signer sign -- --password "$Env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD" -k "tauri.key" "$($MsiFile.FullName)" 2>&1 | Out-String
          Write-Host "Output Firma: $SignOutput"

          $SigFile = "$($MsiFile.FullName).sig"
          if (Test-Path $SigFile) {
             $Signature = Get-Content $SigFile
             Write-Host "✅ Firma OK"
          } else {
             if ($SignOutput -match "([a-zA-Z0-9+/]{60,}=*)") {
                $Signature = $matches[1]
                Write-Host "✅ Firma recuperada del output"
             } else {
                throw "❌ ERROR DE FIRMA: No se pudo firmar MSI."
             }
          }

          # JSON
          $Version = "${{ github.ref_name }}".TrimStart('v')
          $PubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          $DownloadUrl = "https://github.com/${{ github.repository }}/releases/download/v$Version/$($MsiFile.Name)"

          $JsonContent = @"
          {
            "version": "$Version",
            "notes": "Update v$Version",
            "pub_date": "$PubDate",
            "platforms": {
              "windows-x86_64": {
                "signature": "$Signature",
                "url": "$DownloadUrl"
              }
            }
          }
          "@

          $JsonPath = Join-Path (Get-Location) "latest.json"
          Set-Content -Path $JsonPath -Value $JsonContent -Encoding UTF8
          Write-Host "JSON generado en $JsonPath"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            latest.json
