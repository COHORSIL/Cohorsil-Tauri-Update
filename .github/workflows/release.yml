name: Release Windows Raw Key
on:
  push:
    tags:
      - "v*"

jobs:
  release:
    permissions:
      contents: write
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # DECODIFICAR Y LIMPIAR CLAVE (ONLY RAW KEY)
      - name: Decode Signing Key
        env:
          KEY_BASE64: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          $KeyFile = "$PWD\tauri.key"
          $Bytes = [System.Convert]::FromBase64String($env:KEY_BASE64)
          $KeyString = [System.Text.Encoding]::UTF8.GetString($Bytes)

          # Separar por saltos de línea y tomar la segunda línea (la clave real)
          $Lines = $KeyString -split "`n"

          # Intentar encontrar la línea que tiene la clave (empieza por RW)
          $RawKey = ""
          foreach ($line in $Lines) {
              $k = $line.Trim()
              if ($k.StartsWith("RW")) {
                  $RawKey = $k
                  break
              }
          }

          if ($RawKey) {
             [System.IO.File]::WriteAllText($KeyFile, $RawKey, [System.Text.Encoding]::ASCII)
             Write-Host "✅ Clave limpia detectada y escrita (sin comentarios)"
             Write-Host "DEBUG START: $($RawKey.Substring(0, 5))..."
          } else {
             # Fallback si no encuentra RW... escribimos la 2da línea a ciegas
             if ($Lines.Count -ge 2) {
                 $RawKey = $Lines[1].Trim()
                 [System.IO.File]::WriteAllText($KeyFile, $RawKey, [System.Text.Encoding]::ASCII)
                 Write-Host "⚠️ Clave no empezaba por RW, pero usamos línea 2"
             } else {
                 Write-Host "❌ ESTRUCTURA DE CLAVE INESPERADA. Escribiendo todo..."
                 [System.IO.File]::WriteAllText($KeyFile, $KeyString, [System.Text.Encoding]::ASCII)
             }
          }

      # COMPILAR
      - name: Build Tauri App
        run: npm run tauri build

      # FIRMAR Y GENERAR JSON
      - name: Sign and Generate latest.json
        run: |
          $MsiFile = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi" | Select-Object -First 1
          if (-not $MsiFile) { throw "No se encontró el MSI" }

          $Env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD = "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}"

          # Ejecutar firma
          $SignOutput = npm run tauri signer sign -- --password "$Env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD" -k "tauri.key" "$($MsiFile.FullName)" 2>&1 | Out-String
          Write-Host "Output Firma: $SignOutput"

          $SigFile = "$($MsiFile.FullName).sig"
          if (Test-Path $SigFile) {
             $Signature = Get-Content $SigFile
             Write-Host "✅ Firma OK"
          } else {
             # Fallback: Intentar parsear output
             if ($SignOutput -match "([a-zA-Z0-9+/]{60,}=*)") {
                $Signature = $matches[1]
                Write-Host "✅ Firma recuperada del output"
             } else {
                throw "❌ ERROR DE FIRMA"
             }
          }

          # JSON
          $Version = "${{ github.ref_name }}".TrimStart('v')
          $PubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          $DownloadUrl = "https://github.com/${{ github.repository }}/releases/download/v$Version/$($MsiFile.Name)"

          $JsonContent = @"
          {
            "version": "$Version",
            "notes": "Update v$Version",
            "pub_date": "$PubDate",
            "platforms": {
              "windows-x86_64": {
                "signature": "$Signature",
                "url": "$DownloadUrl"
              }
            }
          }
          "@

          $JsonPath = Join-Path (Get-Location) "latest.json"
          Set-Content -Path $JsonPath -Value $JsonContent -Encoding UTF8
          Write-Host "JSON creado en $JsonPath"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            latest.json
