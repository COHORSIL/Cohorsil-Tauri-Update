name: Release Windows Manual
on:
  push:
    tags:
      - "v*"

jobs:
  release:
    permissions:
      contents: write
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # DECODIFICAR CLAVE DESDE BASE64
      - name: Decode Signing Key
        env:
          KEY_BASE64: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          $KeyFile = "$PWD\tauri.key"
          [System.IO.File]::WriteAllBytes($KeyFile, [System.Convert]::FromBase64String($env:KEY_BASE64))
          Write-Host "Clave privada decodificada correctamente en: $KeyFile"

      # COMPILAR (SIN FIRMAR AÚN)
      - name: Build Tauri App
        run: npm run tauri build

      # FIRMAR Y GENERAR JSON A MANO (LA MAGIA)
      - name: Sign and Generate latest.json
        env:
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          # 1. Buscar el MSI generado
          $MsiFile = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi" | Select-Object -First 1
          if (-not $MsiFile) { throw "No se encontró el archivo MSI para firmar" }
          Write-Host "Firmando archivo: $($MsiFile.FullName)"

          # 2. Firmar usando tauri signer
          # Ejecutamos el comando y capturamos TODA la salida
          # NOTA: En Windows, pasar argumentos con espacios o rutas a npx/npm es delicado.
          # Usamos la ruta local de la clave tauri.key

          # Importante: tauri signer sign espera la contraseña por variable de entorno o flag
          $Env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD = "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}"

          # Ejecutar firma y guardar salida en variable
          $SignOutput = npm run tauri signer sign -- --password "$Env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD" -k "tauri.key" "$($MsiFile.FullName)" 2>&1 | Out-String

          Write-Host "Output de Firma: $SignOutput"

          # 3. Extraer la firma Base64 de la salida (Tu clave pública empieza por dW...)
          # La firma suele ser la última línea o estar en el output. 
          # Buscamos una cadena larga que parezca Base64
          # Vamos a buscar el archivo .sig que debería haber generado

          $SigFile = "$($MsiFile.FullName).sig"
          if (Test-Path $SigFile) {
             $Signature = Get-Content $SigFile
             Write-Host "✅ Firma encontrada en archivo .sig: $Signature"
          } else {
             # Si no hay archivo .sig, intentamos parsear (fallback)
             throw "❌ ERROR: El comando signer no generó un archivo .sig"
          }

          # 4. Construir latest.json
          $Version = "${{ github.ref_name }}".TrimStart('v')
          $PubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          $DownloadUrl = "https://github.com/${{ github.repository }}/releases/download/v$Version/$($MsiFile.Name)"

          $JsonContent = @"
          {
            "version": "$Version",
            "notes": "Update v$Version",
            "pub_date": "$PubDate",
            "platforms": {
              "windows-x86_64": {
                "signature": "$Signature",
                "url": "$DownloadUrl"
              }
            }
          }
          "@

          $JsonPath = Join-Path (Get-Location) "latest.json"
          Set-Content -Path $JsonPath -Value $JsonContent -Encoding UTF8
          Write-Host "✅ latest.json generado en: $JsonPath"
          Get-Content $JsonPath

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            latest.json
